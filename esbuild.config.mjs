import esbuild from 'esbuild';
import process from 'process';
import builtins from 'builtin-modules';
import esbuildSvelte from 'esbuild-svelte';
import { sveltePreprocess } from 'svelte-preprocess';

const banner = `/*
Sonar - Deep knowledge retrieval for Obsidian
Copyright (C) 2026 Shuhei Kadowaki

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.

SPDX-License-Identifier: AGPL-3.0-or-later

This is a generated/bundled file by esbuild.
To view the source, visit: https://github.com/aviatesk/obsidian-sonar
*/
`;

const prod = process.argv[2] === 'production';
const includeBenchmark = process.env.INCLUDE_BENCHMARK === 'true';

// Mark benchmark paths as external when not including benchmarks
// This prevents esbuild from bundling benchmark code in production builds
const benchmarkExternals = includeBenchmark
  ? []
  : ['./retrieval-bench/*', './rag-bench/*'];

const context = await esbuild.context({
  banner: {
    js: banner,
  },
  entryPoints: ['main.ts'],
  bundle: true,
  external: [
    'obsidian',
    'electron',
    '@codemirror/autocomplete',
    '@codemirror/collab',
    '@codemirror/commands',
    '@codemirror/language',
    '@codemirror/lint',
    '@codemirror/search',
    '@codemirror/state',
    '@codemirror/view',
    '@lezer/common',
    '@lezer/highlight',
    '@lezer/lr',
    ...builtins,
    ...benchmarkExternals,
  ],
  format: 'cjs',
  target: 'es2018',
  plugins: [
    esbuildSvelte({
      compilerOptions: { css: 'injected' },
      preprocess: sveltePreprocess(),
    }),
  ],
  logLevel: 'info',
  sourcemap: prod ? false : 'inline',
  treeShaking: true,
  define: {
    'process.env.INCLUDE_BENCHMARK': JSON.stringify(
      includeBenchmark ? 'true' : 'false'
    ),
  },
  outfile: 'main.js',
  minify: prod,
});

if (prod) {
  await context.rebuild();
  process.exit(0);
} else {
  await context.watch();
}
